{"version":3,"sources":["WebsiteBuilder.ion"],"names":["ion","File","Directory","builder","utility","ModuleBuilder","clientJsDir","serverJsDir","serverJavaDir","np","packagePatch","packageJson","patch","JSON","parse","read","input","directories","src","output","www","clientOutput","getDirectory","serverOutput","nodepaths","concat","process","env","NODE_PATH","split","delimiter","glassPages","exists","javaDirectory","search","key","source","target","getFile","modified","copyFrom","build","client","modules","moduleName","nodepath","directory","join","exclude","write","path","substring","length","server","lib","test","file","targetPath","changeExtension","compileIon","pageOutput","replace","compileCoffeeScript"],"mappings":"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","sourcesContent":["const\r\n    ion = import '../'\r\n    File = import './File'\r\n    Directory = import './Directory'\r\n    builder = import './'\r\n    utility = import './utility'\r\n    ModuleBuilder = import './ModuleBuilder'\r\n    clientJsDir = 'js'\r\n    serverJsDir = 'WEB-INF/js'\r\n    serverJavaDir = 'WEB-INF/java'\r\n    np = import 'path'\r\n\r\n\r\nexport template (packagePatch) ->\r\n    const\r\n        packageJson = ion.patch(JSON.parse(new File('package.json').read()), packagePatch ? {})\r\n        input = new Directory(packageJson.directories.src ? 'src')\r\n        output = new Directory(packageJson.directories.www ? 'debug')\r\n        clientOutput = output.getDirectory(clientJsDir)\r\n        serverOutput = output.getDirectory(serverJsDir)\r\n        nodepaths = ['node_modules'].concat(process.env.NODE_PATH.split(np.delimiter))\r\n\r\n    # Copy local development versions of glass-pages to input directory if available\r\n    # They will be copied from src to the build directory by ant\r\n    let glassPages = new Directory('../glass-pages/dist')\r\n    if glassPages.exists\r\n        let javaDirectory = input.getDirectory(serverJavaDir)\r\n        for key, source of glassPages.search()\r\n            let target = javaDirectory.getFile(key)\r\n            if target.modified < source.modified\r\n                target.copyFrom(source)\r\n\r\n    # Copy client and server node modules to the output\r\n    for moduleName in packageJson.build.client.modules\r\n        for nodepath in nodepaths\r\n            let directory = new Directory(np.join(nodepath, moduleName))\r\n            for key, source of directory.search([\".js\",\".map\"], [\"node_modules\"].concat(packageJson.build.client.exclude))\r\n                clientOutput.write(source.path.substring(nodepath.length), source.read())\r\n    for moduleName in packageJson.build.server.modules\r\n        for nodepath in nodepaths\r\n            let directory = new Directory(np.join(nodepath, moduleName))\r\n            for key, source of directory.search([\".js\",\".map\"], [\"node_modules\"].concat(packageJson.build.server.exclude))\r\n                serverOutput.write(source.path.substring(nodepath.length), source.read())\r\n\r\n    # build client javascript\r\n    ModuleBuilder(\r\n        directories:\r\n            src:input + '/js' # client side javascript\r\n            lib:output + '/' + clientJsDir\r\n        build:\r\n            exclude: packageJson.build.client.exclude\r\n            test: false\r\n    )\r\n\r\n    # build server javascript\r\n    ModuleBuilder(\r\n        directories:\r\n            src:input + '/js' # server side javascript\r\n            lib:output + '/' + serverJsDir\r\n        build:\r\n            exclude: packageJson.build.server.exclude\r\n            test: true\r\n    )\r\n\r\n    # Copy all other files from src to output\r\n    for path, file of input.search(null, [\".ionpage\",\".coffeepage\",\".coffee\",\".java\",\".class\",\".jar\", \".ion\"])\r\n        output.write(path, file.read())\r\n    else\r\n        output.delete(path)\r\n\r\n    # Compile plain ion files, while excluding the js directory\r\n    for path, file of input.search(\".ion\", \"js\")\r\n        let targetPath = builder.changeExtension(path, \".js\")\r\n        output.write(targetPath, builder.compileIon(file))\r\n    else\r\n        output.delete(targetPath)\r\n\r\n    # Compile ion pages\r\n    let pageOutput = output.getDirectory('WEB-INF/pages')\r\n    for path, file of input.search(\".ionpage\")\r\n        let targetPath = builder.changeExtension(path, \".js\")\r\n        pageOutput.write(targetPath, \"(function {{path.replace(/[\\.\\/\\\\]/g, '_')}}(){ {{builder.compileIon(file)}} })\")\r\n    else\r\n        pageOutput.delete(targetPath)\r\n\r\n    # Compile coffee pages\r\n    # TODO: port all .coffeepages to .ionpages and delete this.\r\n    for path, file of input.search(\".coffeepage\")\r\n        let targetPath = builder.changeExtension(path, \".js\")\r\n        pageOutput.write(targetPath, \"(function {{path.replace(/[\\.\\/\\\\]/g, '_')}}(){ {{builder.compileCoffeeScript(file)}} })\")\r\n    else\r\n        pageOutput.delete(targetPath)\r\n"]}