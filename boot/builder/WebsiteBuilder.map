{"version":3,"sources":["WebsiteBuilder.ion"],"names":["ion","File","Directory","builder","utility","ModuleBuilder","clientJsDir","serverJsDir","serverJavaDir","packagePatch","packageJson","patch","JSON","parse","read","input","directories","src","output","www","clientOutput","getDirectory","serverOutput","nodepath","glassPages","exists","javaDirectory","search","key","source","target","getFile","modified","copyFrom","build","client","modules","moduleName","directory","concat","exclude","path","substring","length","server","lib","test","targetPath","changeExtension","compileIon","pageOutput","replace","compileCoffeeScript"],"mappings":"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","sourcesContent":["const\r\n    ion = import '../'\r\n    File = import './File'\r\n    Directory = import './Directory'\r\n    builder = import './'\r\n    utility = import './utility'\r\n    ModuleBuilder = import './ModuleBuilder'\r\n    clientJsDir = 'js'\r\n    serverJsDir = 'WEB-INF/js'\r\n    serverJavaDir = 'WEB-INF/java'\r\n\r\nexport template (packagePatch) ->\r\n    const\r\n        packageJson = ion.patch(JSON.parse(new File('package.json').read()), packagePatch ? {})\r\n        input = new Directory(packageJson.directories.src ? 'src')\r\n        output = new Directory(packageJson.directories.www ? 'debug')\r\n        clientOutput = output.getDirectory(clientJsDir)\r\n        serverOutput = output.getDirectory(serverJsDir)\r\n        nodepath = 'node_modules/'\r\n\r\n    # Copy local development versions of glass-pages to input directory if available\r\n    # They will be copied from src to the build directory by ant\r\n    let glassPages = new Directory('../glass-pages/dist')\r\n    if glassPages.exists\r\n        let javaDirectory = input.getDirectory(serverJavaDir)\r\n        for key, source of glassPages.search()\r\n            let target = javaDirectory.getFile(key)\r\n            if target.modified < source.modified\r\n                target.copyFrom(source)\r\n\r\n    # Copy client and server node modules to the output\r\n    for moduleName in packageJson.build.client.modules\r\n        let directory = new Directory(nodepath + moduleName)\r\n        for key, source of directory.search([\".js\",\".map\"], [\"node_modules\"].concat(packageJson.build.client.exclude))\r\n            clientOutput:\r\n                [source.path.substring(nodepath.length)]: source.read()\r\n    for moduleName in packageJson.build.server.modules\r\n        let directory = new Directory(nodepath + moduleName)\r\n        for key, source of directory.search([\".js\",\".map\"], [\"node_modules\"].concat(packageJson.build.server.exclude))\r\n            serverOutput:\r\n                [source.path.substring(nodepath.length)]: source.read()\r\n\r\n    # build client javascript\r\n    (ModuleBuilder)\r\n        directories:\r\n            src:input + '/js' # client side javascript\r\n            lib:output + '/' + clientJsDir\r\n        build:\r\n            exclude: packageJson.build.client.exclude\r\n            test: false\r\n\r\n    # build server javascript\r\n    (ModuleBuilder)\r\n        directories:\r\n            src:input + '/js' # server side javascript\r\n            lib:output + '/' + serverJsDir\r\n        build:\r\n            exclude: packageJson.build.server.exclude\r\n            test: true\r\n\r\n    # Copy all other files from src to output\r\n    for key, source of input.search(null, [\".ionpage\",\".coffeepage\",\".coffee\",\".java\",\".class\",\".jar\", \".ion\"])\r\n        let target = output.getFile(key)\r\n        output:\r\n            [key]: source.read()\r\n\r\n    # Compile plain ion files, while excluding the js directory\r\n    for key, source of input.search(\".ion\", \"js\")\r\n        let targetPath = builder.changeExtension(key, \".js\")\r\n        output:\r\n            [targetPath]: builder.compileIon(source)\r\n\r\n    # Compile ion pages\r\n    let pageOutput = output.getDirectory('WEB-INF/pages')\r\n    for key, source of input.search(\".ionpage\")\r\n        let targetPath = builder.changeExtension(key, \".js\")\r\n        pageOutput:\r\n            [targetPath]: \"(function {{key.replace(/[\\.\\/\\\\]/g, '_')}}(){ {{builder.compileIon(source)}} })\"\r\n\r\n    # Compile coffee pages\r\n    # TODO: port all .coffeepages to .ionpages and delete this.\r\n    for key, source of input.search(\".coffeepage\")\r\n        let targetPath = builder.changeExtension(key, \".js\")\r\n        pageOutput:\r\n            [targetPath]: \"(function {{key.replace(/[\\.\\/\\\\]/g, '_')}}(){ {{builder.compileCoffeeScript(source)}} })\"\r\n"]}