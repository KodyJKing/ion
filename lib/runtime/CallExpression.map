{"version":3,"sources":["CallExpression.ion"],"names":["ion","DynamicExpression","ArrayExpression","Factory","CallExpression","properties","args","activate",{"type":"Identifier","name":"activate","loc":{"start":{"line":8,"column":8,"fixed":true,"source":"ion/runtime/CallExpression.ion"},"end":{"line":8,"column":16,"fixed":true,"source":"ion/runtime/CallExpression.ion"}}},"calleeExpression","context","createRuntime","callee","unobserveCallee","observe","calleeWatcher","value","isActive","existential","loc","start","source","console","warn","toCode","line","column","calleeValue","queueEvaluate","unobserveCalleeObject","objectExpression","thisWatcher","thisArg","unobserveThis","template","deep","patch","watch","thisObserver","argumentExpressions","type","elements","arguments","observeElements","unobserveArguments","argumentWatcher","argumentsValue","deactivate","cancelQueuedEvaluate","unobserveTemplate","hasEvaluated","evaluate","nextCheck","boundEvaluate","bind","lastCalleeValue","lastThisArg","index","arg","lastArgumentsValue","apply","templateWatcher","setValue","create","e","error","module","exports"],"mappings":"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","sourcesContent":["const\n    ion = import '../'\n    {DynamicExpression,ArrayExpression,Factory} = import './'\n\nmodule.exports = class CallExpression extends DynamicExpression\n    properties:\n        args: null\n        activate: ->\n            super\n            @calleeExpression ?= @context.createRuntime(@callee)\n            @unobserveCallee = @calleeExpression.observe(\n                @calleeWatcher ?= (value) =>\n                    if @isActive and not value? and not @existential and @loc?.start.source?\n                        # we need to throw an exception here with location info\n                        console.warn(\"Function is {{value}} ({{Factory.toCode(@callee)}}) ({{@loc.start.source}}:{{@loc.start.line}}:{{@loc.start.column + 1}})\")\n                    @calleeValue = value\n                    @queueEvaluate()\n            )\n            # get thisArg and observe for changes\n            @unobserveCalleeObject = @calleeExpression.objectExpression?.observe(\n                @thisWatcher ?= (thisArg) =>\n                    if thisArg isnt @thisArg\n                        @unobserveThis?()\n                        @unobserveThis = null\n                        @thisArg = thisArg\n                        if not @calleeValue?.template # we don't need to observe the thisArg if the callee is a template\n                            if @calleeExpression.objectExpression.deep\n                                # console.log('deep observe man-------------------------', thisArg, @calleeValue)\n                                # deep observe\n                                @unobserveThis = ion.patch.watch(\n                                    thisArg\n                                    @thisObserver ?= (patch) =>\n                                        # console.log('deep change', patch)\n                                        @queueEvaluate()\n                                )\n                            else\n                                # shallow observe\n                                @unobserveThis = ion.observe(\n                                    thisArg\n                                    @thisObserver ?= =>\n                                        @queueEvaluate()\n                                )\n                        @queueEvaluate()\n            )\n            @argumentExpressions ?= @context.createRuntime({type:'ArrayExpression',elements:@arguments, observeElements:not @calleeValue?.template})\n            @unobserveArguments = @argumentExpressions.observe(\n                @argumentWatcher ?= (value) =>\n                    @argumentsValue = value\n                    @queueEvaluate()\n            )\n        deactivate: ->\n            super\n            @cancelQueuedEvaluate?()\n            @unobserveCallee()\n            @unobserveArguments()\n            @unobserveCalleeObject?()\n            @unobserveThis?()\n            @unobserveTemplate?()\n        queueEvaluate: ->\n            if not @hasEvaluated?\n                @evaluate()\n            else if not @cancelQueuedEvaluate?\n                @cancelQueuedEvaluate = ion.nextCheck(@boundEvaluate ?= @evaluate.bind(@))\n        evaluate: ->\n            @cancelQueuedEvaluate = null\n\n            if not (@isActive and @calleeValue? and @argumentsValue? and (@thisArg? or not @calleeExpression.objectExpression?))\n                return\n\n\n            @hasEvaluated = true\n\n            let value = undefined\n\n            if @unobserveTemplate? and @lastCalleeValue is @calleeValue and @lastThisArg is @thisArg\n                #   if only the arguments have changed, we don't need to call a template again,\n                #   we can just change the previous argument values\n                for arg, index in @argumentsValue\n                    if @lastArgumentsValue[index] isnt arg\n                        @lastArgumentsValue[index] = arg\n                # console.log('change template arguments template-------------------')\n                return\n\n            # if @calleeValue.template\n            #     console.log('reevaluate template-------------------')\n            #     console.log(\n            #         thisArgChanged: @lastThisArg isnt @thisArg\n            #         calleeChanged: @lastCalleeValue isnt @calleeValue\n            #     )\n\n            @lastCalleeValue = @calleeValue\n            @lastArgumentsValue = @argumentsValue\n            @lastThisArg = @thisArg\n\n            @unobserveTemplate?()\n            @unobserveTemplate = null\n            try\n                if @calleeValue.template\n                    # always use new on templates\n                    @template = @calleeValue.apply(@thisArg, @argumentsValue)\n                    @unobserveTemplate = @template.observe(@templateWatcher ?= @setValue.bind(@))\n                else\n                    if @type is 'NewExpression'\n                        # create a new with variable args\n                        value = ion.create(@calleeValue, @argumentsValue)\n                    else # @type is 'CallExpression'\n                        value = @calleeValue.apply(@thisArg, @argumentsValue)\n                    @setValue(value)\n            catch e\n                let start = @loc.start\n                console.error(\"Call Error at {{start.source}} (line:{{start.line}},column:{{start.column}})\")\n                console.error(e)\n                throw e\n"]}