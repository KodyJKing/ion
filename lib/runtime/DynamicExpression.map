{"version":3,"sources":["DynamicExpression.ion"],"names":["ion","DynamicExpression","properties","isActive","activate",{"type":"Identifier","name":"activate","loc":{"start":{"line":6,"column":8,"fixed":true},"end":{"line":6,"column":16,"fixed":true}}},"deactivate","watch","watcher","watchers","_watchers","length","push","hasValue","value","getValue","_notifyWatcher","unwatch","remove","call","notify","hasOwnProperty","setValue","test","d","total"],"mappings":"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","sourcesContent":["const ion = import '../'\r\n\r\nexport class DynamicExpression extends import './Expression'\r\n    properties:\r\n        isActive: false\r\n        activate: ->\r\n            # called when we have watchers\r\n            @isActive = true\r\n        deactivate: ->\r\n            # called when we no longer have watchers\r\n            @isActive = false\r\n        watch: (watcher) ->\r\n            let watchers = @_watchers ?= []\r\n            if watchers.length is 0\r\n                @activate()\r\n            watchers.push(watcher)\r\n            # notify watcher immediately if we have a value\r\n            if @hasValue()\r\n                let value = @getValue()\r\n                @_notifyWatcher(watcher, value)\r\n        unwatch: (watcher) ->\r\n            @_watchers.remove(watcher)\r\n            # notify watcher immediately if we have a value\r\n            if @hasValue()\r\n                @_notifyWatcher(watcher, undefined)\r\n            # this must happen AFTER we notify the watcher,\r\n            # otherwise it changes the value and the watcher may not be notified.\r\n            if @_watchers.length is 0\r\n                @deactivate()\r\n        _notifyWatcher: (watcher, value) -> watcher.call(@, value)\r\n        notify: ->\r\n            if @_watchers?\r\n                let value = @getValue()\r\n                for watcher in @_watchers\r\n                    @_notifyWatcher(watcher, value)\r\n            return\r\n        hasValue: -> @hasOwnProperty('value')\r\n        getValue: -> @value\r\n        setValue: (value) ->\r\n            if value isnt @value or not @hasValue()\r\n                @value = value\r\n                @notify()\r\n            return\r\n    test: ->\r\n        const d = new DynamicExpression()\r\n        if d.getValue() isnt undefined\r\n            throw \"d.getValue() != undefined\"\r\n        let total = 10\r\n        const watcher = (value) ->\r\n            if value isnt undefined\r\n                total += value\r\n        d.watch(watcher)\r\n        assert total is 10\r\n        d.setValue(10)\r\n        assert d.getValue() is 10\r\n        assert total is 20\r\n        d.setValue(20)\r\n        assert total is 40\r\n        d.unwatch(watcher)\r\n        assert total is 40\r\n        d.setValue(50)\r\n        assert total is 40\r\n"]}