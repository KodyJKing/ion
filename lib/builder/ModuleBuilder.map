{"version":3,"sources":["ModuleBuilder.ion"],"names":["global","window","ion","np","File","Directory","builder","utility","compilers","compile","compileCoffeeScript","compilePegjs","shimJavascript","compileIon","compileWithSourceMap","compileIonWithSourceMap"],"mappings":"aAAA;AAAA,IAAGA,MAAA,CAAOC,MAAV,EACA;AAAA,IAAI,OAAJ;AAAA,CADA;AAGA,IACIC,GAAA,G,OAAM,CAAO,KAAP,CADV,EAEIC,EAAA,G,OAAK,CAAO,MAAP,CAFT,EAGIC,IAAA,G,OAAO,CAAO,QAAP,CAHX,EAIIC,SAAA,G,OAAY,CAAO,aAAP,CAJhB,EAKIC,OAAA,G,OAAU,CAAO,IAAP,CALd,EAMIC,OAAA,G,OAAU,CAAO,WAAP,CANd,EAQIC,SAAA,GAAW;AAAA,Q,SACP,EAAU,EACNC,OAAA,EAASH,OAAA,CAAQI,mBADX,EADH;AAAA,Q,QAGP,EAAS,EACLD,OAAA,EAASH,OAAA,CAAQK,YADZ,EAHF;AAAA,Q,KAKP,EAAM,EACFF,OAAA,EAASH,OAAA,CAAQM,cADf,EALC;AAAA,Q,MAOP,EAAO;AAAA,YACHH,OAAA,EAASH,OAAA,CAAQO,UADd;AAAA,YAEHC,oBAAA,EAAsBR,OAAA,CAAQS,uBAF3B;AAAA,SAPA;AAAA,KARf,CAHA","sourcesContent":["if global.window\r\n    return\r\n\r\nconst\r\n    ion = import '../'\r\n    np = import 'path'\r\n    File = import './File'\r\n    Directory = import './Directory'\r\n    builder = import './'\r\n    utility = import './utility'\r\n\r\n    compilers =\r\n        \".coffee\":\r\n            compile: builder.compileCoffeeScript\r\n        \".pegjs\":\r\n            compile: builder.compilePegjs\r\n        \".js\":\r\n            compile: builder.shimJavascript\r\n        \".ion\":\r\n            compile: builder.compileIon\r\n            compileWithSourceMap: builder.compileIonWithSourceMap\r\n\r\nexport template (packagePatch) ->\r\n    let packageJson = ion.patch(JSON.parse(new File('package.json').read()), packagePatch ? {})\r\n    let input = new Directory(packageJson.directories.src ? 'src')\r\n    let output = new Directory(packageJson.directories.lib ? 'lib')\r\n    let moduleName = packageJson.name ? ''\r\n\r\n    # build all source files with a single search\r\n    let extensions = Object.keys(compilers)\r\n    for path, source of input.search(extensions, packageJson.build.exclude)\r\n        if not source.isDirectory\r\n            let compiler = compilers[source.getExtension()]\r\n            let targetPath = builder.changeExtension(path, '.js')\r\n            if compiler.compileWithSourceMap?\r\n                let mapPath = builder.changeExtension(path, '.map')\r\n                let mapName = mapPath.split(/[\\/\\\\]/g).slice(-1)[0]\r\n                let [code,map] = compiler.compileWithSourceMap(source, packageJson)\r\n                output.write(targetPath, code + \"\\n//@ sourceMappingURL=./\" + mapName)\r\n                output.write(mapPath, map)\r\n            else\r\n                output.write(targetPath, compiler.compile(source, packageJson))\r\n    else\r\n        output.delete(targetPath)\r\n        output.delete(mapPath)\r\n\r\n    # build a default index file for each output directory\r\n    for path, file of input.search(null, extensions.concat(packageJson.build.exclude))\r\n        if file.isDirectory\r\n            # see if there is an input.js or input.ion file\r\n            let isInputFile = input.getFile(path + \"/index.js\").exists or input.getFile(path + \"/index.ion\").exists or input.getFile(path + \"/index.coffee\").exists\r\n            if not isInputFile\r\n                # then create an output file\r\n                let indexDirectory = output.getDirectory(path)\r\n                let indexName = \"index.js\"\r\n                let indexFile = indexDirectory.getFile(indexName)\r\n                # get a list of all output files in that directory\r\n                let lines = []\r\n                    for key, childFile of indexDirectory.search(\".js\", null, {recursive:false})\r\n                        if key isnt indexName\r\n                            let name = key.substring(0, key.lastIndexOf('.js'))\r\n                            \"Object.defineProperty(exports, '{{name}}', {get:function(){ return require('./{{name}}') }}) \"\r\n\r\n                let indexModuleId = np.join(moduleName, path, \"index\").replace(/\\\\/g, '/')\r\n                indexFile.write(builder.addBrowserShim(lines.join('\\n'), indexModuleId))\r\n\r\n    # build a manifest file with require.js at the top\r\n    # ignore output _browser.js and node_modules\r\n    let outputFiles = output.search(\".js\", [/^_/, 'node_modules'].concat(Object.keys(packageJson.build.merge ? {})))\r\n    let top = [key for key of outputFiles if key.endsWith('require.js')]\r\n    let sortedFiles = top.concat([key for key of outputFiles if not builder.isPrivate(key) and top.indexOf(key) < 0])\r\n    let manifestFileName = \"manifest.json\"\r\n    let manifestFile = output.getFile(manifestFileName)\r\n    let manifest =\r\n        modified: Math.max.apply(null, [file.modified for path, file of outputFiles])\r\n        files: [builder.normalizePath(path) for path in sortedFiles]\r\n    manifestFile.write(JSON.stringify(manifest, null, '  ', sortedFiles))\r\n\r\n    # build merged file, just so we can test locally with file:// protocol\r\n    if packageJson.build.merge?\r\n        for mergeFile, options of packageJson.build.merge\r\n            let mergedArray = []\r\n                for index, name of sortedFiles\r\n                    if not utility.isMatch(name, options.exclude, false)\r\n                        [index]: outputFiles[name].read()\r\n                    else\r\n                        [index]: \"\"\r\n                else\r\n                    [index]: \"\"\r\n\r\n            let merged = mergedArray.join('\\n')\r\n            if options.compress\r\n                let minified = require('uglify-js').minify(merged, {fromString:true}).code\r\n                output.write(mergeFile, minified)\r\n            else\r\n                output.write(mergeFile, merged)\r\n\r\n    # copy the package.json to the lib directory\r\n    if packageJson.build.package isnt false\r\n        output.write('package.json', JSON.stringify(ion.patch(ion.clone(packageJson), {main:undefined}), null, '    '))\r\n        # # also copy the bower.json file if present\r\n        # let bower = new File('bower.json')\r\n        # if bower.exists\r\n        #     output.write('bower.json', bower.read())\r\n\r\n    # builder.test\r\n    if packageJson.build.test isnt false\r\n        builder.runTests(manifestFile, manifestFile.modified)\r\n"]}